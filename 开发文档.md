# 云容器监控平台 - 开发文档

## 1. 项目概述

### 1.1 项目目标
开发一个统一的多云容器监控平台，支持 Zeabur、Render、Koyeb、Vercel 四个平台的容器状态监控和管理。

### 1.2 核心功能
- 用户登录和 JWT 认证
- 多平台容器状态实时监控
- 容器操作（重启、暂停、删除、查看日志）
- 告警通知（邮件/Webhook）
- 批量操作支持

### 1.3 技术栈
- **后端**: Node.js + Express
- **前端**: Vue.js 3 + Vite
- **数据库**: SQLite
- **认证**: JWT Token
- **定时任务**: node-cron
- **HTTP 客户端**: axios

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────┐
│   Vue.js    │  前端界面
│  Dashboard  │
└──────┬──────┘
       │ HTTP/WebSocket
┌──────▼──────┐
│   Express   │  API 服务器
│   Server    │
└──────┬──────┘
       │
┌──────▼──────┐
│   SQLite    │  数据存储
│  Database   │
└─────────────┘
       │
┌──────▼──────────────────────┐
│  Platform API Adapters      │
├─────────┬─────────┬─────────┤
│ Zeabur  │ Render  │ Koyeb   │
│         │         │ Vercel  │
└─────────┴─────────┴─────────┘
```

### 2.2 目录结构
```
cloud-monitor/
├── backend/                    # 后端服务
│   ├── src/
│   │   ├── config/            # 配置文件
│   │   │   └── database.js
│   │   ├── middleware/        # 中间件
│   │   │   ├── auth.js       # JWT 认证
│   │   │   └── errorHandler.js
│   │   ├── models/            # 数据模型
│   │   │   ├── User.js
│   │   │   ├── Platform.js
│   │   │   ├── Container.js
│   │   │   └── Alert.js
│   │   ├── routes/            # 路由
│   │   │   ├── auth.js
│   │   │   ├── platforms.js
│   │   │   ├── containers.js
│   │   │   └── alerts.js
│   │   ├── services/          # 业务逻辑
│   │   │   ├── platformAdapters/
│   │   │   │   ├── ZeaburAdapter.js
│   │   │   │   ├── RenderAdapter.js
│   │   │   │   ├── KoyebAdapter.js
│   │   │   │   └── VercelAdapter.js
│   │   │   ├── monitorService.js
│   │   │   └── alertService.js
│   │   ├── utils/             # 工具函数
│   │   │   └── logger.js
│   │   └── app.js             # 应用入口
│   ├── package.json
│   └── .env.example
├── frontend/                   # 前端应用
│   ├── src/
│   │   ├── api/               # API 调用
│   │   ├── components/        # 组件
│   │   ├── views/             # 页面
│   │   ├── router/            # 路由
│   │   ├── store/             # 状态管理
│   │   └── App.vue
│   ├── package.json
│   └── vite.config.js
└── README.md
```

## 3. 数据库设计

### 3.1 用户表 (users)
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  email VARCHAR(100),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 平台配置表 (platforms)
```sql
CREATE TABLE platforms (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  platform_type VARCHAR(20) NOT NULL, -- zeabur, render, koyeb, vercel
  api_key VARCHAR(255) NOT NULL,
  api_secret VARCHAR(255),
  enabled BOOLEAN DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 3.3 容器记录表 (containers)
```sql
CREATE TABLE containers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  platform_id INTEGER NOT NULL,
  container_id VARCHAR(100) NOT NULL,
  container_name VARCHAR(100),
  status VARCHAR(20), -- running, stopped, error, etc.
  last_check DATETIME,
  metadata TEXT, -- JSON 格式存储额外信息
  FOREIGN KEY (platform_id) REFERENCES platforms(id)
);
```

### 3.4 告警记录表 (alerts)
```sql
CREATE TABLE alerts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  container_id INTEGER NOT NULL,
  alert_type VARCHAR(20), -- status_change, error, etc.
  message TEXT,
  notified BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (container_id) REFERENCES containers(id)
);
```

### 3.5 告警配置表 (alert_configs)
```sql
CREATE TABLE alert_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  notification_type VARCHAR(20), -- email, webhook
  config TEXT, -- JSON 格式存储配置（邮箱地址、webhook URL等）
  enabled BOOLEAN DEFAULT 1,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## 4. API 设计

### 4.1 认证相关
```
POST   /api/auth/register      # 用户注册
POST   /api/auth/login         # 用户登录
POST   /api/auth/refresh       # 刷新 Token
GET    /api/auth/profile       # 获取用户信息
```

### 4.2 平台管理
```
GET    /api/platforms          # 获取平台列表
POST   /api/platforms          # 添加平台配置
PUT    /api/platforms/:id      # 更新平台配置
DELETE /api/platforms/:id      # 删除平台配置
GET    /api/platforms/:id/test # 测试平台连接
```

### 4.3 容器管理
```
GET    /api/containers                    # 获取所有容器
GET    /api/containers/:id                # 获取容器详情
POST   /api/containers/:id/restart        # 重启容器
POST   /api/containers/:id/stop           # 停止容器
DELETE /api/containers/:id                # 删除容器
GET    /api/containers/:id/logs           # 获取容器日志
POST   /api/containers/batch              # 批量操作
GET    /api/containers/refresh            # 手动刷新容器状态
```

### 4.4 告警管理
```
GET    /api/alerts                # 获取告警列表
GET    /api/alerts/configs        # 获取告警配置
POST   /api/alerts/configs        # 添加告警配置
PUT    /api/alerts/configs/:id    # 更新告警配置
DELETE /api/alerts/configs/:id    # 删除告警配置
```

## 5. 平台 API 适配器设计

### 5.1 适配器接口规范
每个平台适配器需要实现以下方法：

```javascript
class PlatformAdapter {
  constructor(apiKey, apiSecret) {}

  // 获取所有容器/服务列表
  async listContainers() {}

  // 获取单个容器详情
  async getContainer(containerId) {}

  // 重启容器
  async restartContainer(containerId) {}

  // 停止容器
  async stopContainer(containerId) {}

  // 删除容器
  async deleteContainer(containerId) {}

  // 获取容器日志
  async getContainerLogs(containerId, options) {}

  // 测试 API 连接
  async testConnection() {}
}
```

### 5.2 各平台 API 端点

#### Zeabur
- Base URL: `https://gateway.zeabur.com/graphql`
- 认证方式: Bearer Token
- 主要操作: GraphQL 查询

#### Render
- Base URL: `https://api.render.com/v1`
- 认证方式: Bearer Token
- 主要端点:
  - GET `/services` - 列出服务
  - GET `/services/{serviceId}` - 服务详情
  - POST `/services/{serviceId}/restart` - 重启服务

#### Koyeb
- Base URL: `https://api.koyeb.com/v1`
- 认证方式: Bearer Token
- 主要端点:
  - GET `/services` - 列出服务
  - GET `/services/{id}` - 服务详情
  - POST `/services/{id}/redeploy` - 重新部署

#### Vercel
- Base URL: `https://api.vercel.com`
- 认证方式: Bearer Token
- 主要端点:
  - GET `/v9/projects` - 列出项目
  - GET `/v13/deployments` - 列出部署
  - DELETE `/v13/deployments/{id}` - 删除部署

## 6. 监控服务设计

### 6.1 定时监控任务
使用 `node-cron` 实现定时轮询：

```javascript
// 每 5 分钟检查一次所有容器状态
cron.schedule('*/5 * * * *', async () => {
  await monitorService.checkAllContainers();
});
```

### 6.2 监控流程
1. 从数据库获取所有启用的平台配置
2. 遍历每个平台，调用对应适配器获取容器列表
3. 对比数据库中的历史状态，检测状态变化
4. 如果状态异常，创建告警记录
5. 触发告警通知（邮件/Webhook）
6. 更新数据库中的容器状态

### 6.3 告警触发条件
- 容器状态从 running 变为 stopped/error
- 容器响应超时
- 容器资源使用率超过阈值（如果 API 支持）

## 7. 前端设计

### 7.1 页面结构
```
├── Login (登录页)
├── Dashboard (仪表盘)
│   ├── Overview (概览)
│   ├── Platforms (平台管理)
│   ├── Containers (容器列表)
│   ├── Alerts (告警中心)
│   └── Settings (设置)
```

### 7.2 核心组件
- **PlatformCard**: 平台配置卡片
- **ContainerTable**: 容器列表表格
- **ContainerActions**: 容器操作按钮组
- **AlertList**: 告警列表
- **LogViewer**: 日志查看器

### 7.3 状态管理
使用 Pinia 管理全局状态：
- `authStore`: 用户认证状态
- `platformStore`: 平台配置
- `containerStore`: 容器数据
- `alertStore`: 告警数据

## 8. 安全设计

### 8.1 认证与授权
- 使用 bcrypt 加密用户密码
- JWT Token 有效期 24 小时
- Refresh Token 有效期 7 天
- 所有 API 请求需要验证 JWT Token

### 8.2 API 密钥存储
- 平台 API 密钥使用 AES-256 加密存储
- 加密密钥从环境变量读取

### 8.3 请求限流
- 使用 express-rate-limit 限制 API 请求频率
- 登录接口：每 IP 每 15 分钟最多 5 次

## 9. 部署方案

### 9.1 环境变量配置
```env
# 服务器配置
PORT=3000
NODE_ENV=production

# JWT 配置
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=24h
REFRESH_TOKEN_EXPIRES_IN=7d

# 数据库
DATABASE_PATH=./data/monitor.db

# 加密密钥
ENCRYPTION_KEY=your-encryption-key

# 告警配置
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASS=your-password
```

### 9.2 部署步骤
1. 安装依赖: `npm install`
2. 构建前端: `cd frontend && npm run build`
3. 初始化数据库: `npm run db:init`
4. 启动服务: `npm start`

### 9.3 Docker 部署（可选）
提供 Dockerfile 和 docker-compose.yml 支持容器化部署。

## 10. 开发计划

### Phase 1: 基础框架（1-2 周）
- [ ] 搭建后端 Express 项目
- [ ] 搭建前端 Vue 项目
- [ ] 实现用户认证系统
- [ ] 设计并创建数据库表

### Phase 2: 平台适配器（2-3 周）
- [ ] 实现 Zeabur 适配器
- [ ] 实现 Render 适配器
- [ ] 实现 Koyeb 适配器
- [ ] 实现 Vercel 适配器
- [ ] 编写适配器单元测试

### Phase 3: 监控服务（1-2 周）
- [ ] 实现定时监控任务
- [ ] 实现状态变化检测
- [ ] 实现告警服务
- [ ] 实现邮件/Webhook 通知

### Phase 4: 前端界面（2-3 周）
- [ ] 实现登录页面
- [ ] 实现仪表盘
- [ ] 实现平台管理页面
- [ ] 实现容器列表和操作
- [ ] 实现告警中心

### Phase 5: 测试与优化（1 周）
- [ ] 集成测试
- [ ] 性能优化
- [ ] 文档完善
- [ ] 部署上线

## 11. 技术难点与解决方案

### 11.1 不同平台 API 差异
**问题**: 四个平台的 API 设计差异较大
**解决**: 使用适配器模式统一接口，内部处理差异

### 11.2 实时性要求
**问题**: 容器状态需要实时更新
**解决**: 结合定时轮询 + WebSocket 推送

### 11.3 API 限流
**问题**: 各平台有 API 调用频率限制
**解决**: 实现请求队列和缓存机制

### 11.4 错误处理
**问题**: 平台 API 可能不稳定
**解决**: 实现重试机制和降级策略

## 12. 后续扩展

- 支持更多云平台（AWS、Azure、GCP 等）
- 添加资源使用率监控（CPU、内存、网络）
- 实现自动扩缩容
- 添加成本分析功能
- 支持多用户团队协作
